@page "/privacy-consent"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using ReMindHealth.Data
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<div class="privacy-consent-container">
    <button class="back-button" @onclick="GoBack">
        <span>←</span>
    </button>

    <div class="consent-card">
        <h1>Einverständnis erforderlich</h1>
               <img src="images/einverstaenis.png" alt="Arztgespräch Illustration" class="mobile-image" />


        <div class="consent-text">
            <p class="primary-text">
                Bitte informieren Sie Ihren Arzt oder Ärztin, dass Sie das Gespräch aufnehmen möchten
            </p>

            <p class="secondary-text">
                Diese Aufnahme darf nur mit Zustimmung aller Beteiligten erfolgen
            </p>
        </div>

        <div class="checkbox-container">
            <label class="checkbox-label">
                <input type="checkbox" @bind="hasConsented" />
                <span class="checkmark"></span>
                <span class="checkbox-text">
                    Ich habe meinen Arzt/ meine Ärztin informiert
                </span>
            </label>
        </div>

        <button class="consent-button"
                @onclick="ConfirmConsent"
                disabled="@(!hasConsented)">
            Weiter zur Aufnahme
        </button>

        <div class="info-box">
            <p><strong>📋 Datenschutz:</strong></p>
            <ul>
                <li>Ihre Aufnahmen werden verschlüsselt gespeichert</li>
                <li>Nur Sie haben Zugriff auf Ihre Daten</li>
            </ul>
        </div>
    </div>
</div>

@code {
    private bool hasConsented = false;

    private async Task ConfirmConsent()
    {
        if (!hasConsented) return;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    appUser.HasAcceptedPrivacy = true;
                    await UserManager.UpdateAsync(appUser);
                }
            }

            NavigationManager.NavigateTo("/record");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving consent: {ex.Message}");
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/dashboard");
    }
}