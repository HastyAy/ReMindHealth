@page "/privacy-consent"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using ReMindHealth.Data
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<div class="privacy-consent-container">
    <button class="back-button" @onclick="GoBack">
        <span>←</span>
    </button>

    <div class="consent-card">
        <div class="icon-section">
            <div class="clipboard-icon">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="20" y="10" width="60" height="80" rx="5" fill="#B8D4FF" stroke="#4A90E2" stroke-width="2" />
                    <circle cx="50" cy="20" r="8" fill="#4A90E2" />
                    <path d="M 35 45 L 45 55 L 65 35" stroke="#4A90E2" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <div class="person-icon">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="35" r="15" fill="#2C3E50" />
                    <path d="M 30 60 Q 50 50 70 60 L 70 85 Q 50 90 30 85 Z" fill="#5CD6B4" />
                </svg>
            </div>
        </div>

        <h1>Einverständnis erforderlich</h1>

        <div class="consent-text">
            <p class="primary-text">
                Bitte informieren Sie Ihren Arzt oder Ärztin, dass Sie das Gespräch aufnehmen möchten
            </p>

            <p class="secondary-text">
                Diese Aufnahme darf nur mit Zustimmung aller Beteiligten erfolgen
            </p>
        </div>

        <div class="checkbox-container">
            <label class="checkbox-label">
                <input type="checkbox" @bind="hasConsented" />
                <span class="checkmark"></span>
                <span class="checkbox-text">
                    Ich habe meinen Arzt/ meine Ärztin informiert
                </span>
            </label>
        </div>

        <button class="consent-button"
                @onclick="ConfirmConsent"
                disabled="@(!hasConsented)">
            Weiter zur Aufnahme
        </button>

        <div class="info-box">
            <p><strong>📋 Datenschutz:</strong></p>
            <ul>
                <li>Ihre Aufnahmen werden verschlüsselt gespeichert</li>
                <li>Nur Sie haben Zugriff auf Ihre Daten</li>
            </ul>
        </div>
    </div>
</div>

@code {
    private bool hasConsented = false;

    private async Task ConfirmConsent()
    {
        if (!hasConsented) return;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                if (appUser != null)
                {
                    appUser.HasAcceptedPrivacy = true;
                    await UserManager.UpdateAsync(appUser);
                }
            }

            NavigationManager.NavigateTo("/record");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving consent: {ex.Message}");
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/dashboard");
    }
}